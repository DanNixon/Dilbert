<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Dilbert: Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Dilbert
   </div>
   <div id="projectbrief">Firmware for the Dilbert interactive badge.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This aims to provide a general overview of the badge, important stuff, troubleshooting and building/flashing.</p>
<h2>Power</h2>
<p><b>The <em>PWR IN</em> header accepts up to 6v only</b>, this is good for either a USB power bank or a single cell lithium battery.</p>
<p><b>There is no reverse polarity protection!</b> I don't know exactly what would happen if you connected the supply in reverse polarity, I haven't tried.</p>
<p>If using a bare battery keep in mind that <b>there is no voltage detection or protection on the board</b> (other than the internal supply voltage measurement on the ESPs ADC) and that the regulator will operate as far down as 3.3V.</p>
<p>Therefore it is your responsibility to make sure the cell voltage of a battery used to power the board does not fall too low.</p>
<p>An ideal battery to power the board if only used for low power applications (i.e. no WiFi, no NeoPixels and no external modules) is a 240mAh or 380mAh micro quad (e.g. Hubsan) battery.</p>
<p>I find that when the battery voltage does start to fall the MCP23017 is the first device to fail, which is noticeable by the buttons becoming unresponsive.</p>
<h2>Assembly</h2>
<p>Most of this is self explanatory, but just a few pointers:</p>
<ul>
<li>Do not reflow solder the ESP12 (reflowing my bridge vias on the ESP and the <a class="el" href="classDilbert.html" title="Main hardware abstraction class. ">Dilbert</a> board)</li>
<li>Reflow solder the NeoPixels (it is much more difficult to make an arse of reflowing them)</li>
<li>Mod wires must be added to connect the ground of the first NeoPixel and the VCC of the last NeoPixel</li>
<li>Make sure everything works before soldering in the LCD, the holes are tight enough for a good connection to be made without soldering</li>
</ul>
<h2>MCP23017</h2>
<p>There are a pair of solder bridge pads near the <em>X1</em> designator (bottom left of the ESP12) that connect the interrupt output of the MCP23017 to the TXd of the ESP8266 UART.</p>
<p>This connection is made by default using a small trace between the pads. It can be removed easily with a small screwdriver by scraping the trace between the pads away and remade by flowing solder over the pads.</p>
<p>If you have issues flashing the board that are not due to lack of power then try breaking this connection.</p>
<h2>Software</h2>
<p>There are a few examples that show how to do most things you would want to do on the board.</p>
<p>Graphics are handled by the <a href="https://github.com/adafruit/Adafruit-GFX-Library">Adafruit GFX library</a>, NeoPixels are handled by the <a href="https://github.com/adafruit/Adafruit_NeoPixel">Adafruit NeoPixel library</a>, if you choose to use the additional IO pins of the MCP23017 they are accessed using the [Adafruit MCP23017 library](<a href="https://github.com/adafruit/Adafruit-MCP23017-Arduino-Library">https://github.com/adafruit/Adafruit-MCP23017-Arduino-Library</a>), buttons are managed using <a href="https://github.com/DanNixon/ArduinoUniversalInput">Universal Inputs</a>.</p>
<p>Instances to the drivers of each of these devices are provided by the <code><a class="el" href="classDilbert.html" title="Main hardware abstraction class. ">Dilbert</a></code> object:</p>
<ul>
<li>Display: <code><a class="el" href="classDilbert.html#ac7a2a5b07a60486d302158ba2ef85355" title="Gets the TFT display driver. ">Dilbert::display()</a></code></li>
<li>NeoPIxels: <code><a class="el" href="classDilbert.html#a7de060b9463ac032160b8b4686443eaa" title="Gets the NeoPixel LED driver. ">Dilbert::neoPixels()</a></code></li>
<li>MCP23017: <code><a class="el" href="classDilbert.html#a3ed7f0c1374494e003eeabe46b27aaf6" title="Gets the IO expender driver. ">Dilbert::io()</a></code></li>
<li>Buttons: <code><a class="el" href="classDilbert.html#a05dd32f433a9cfe62aaccac2d8ad1775" title="Gets the button manager. ">Dilbert::buttons()</a></code></li>
</ul>
<p>The backlight intensity can be set using either <code><a class="el" href="classDilbert.html#a2976f858f28e4dda389e75b88f95e364" title="Sets the backlight intensity. ">Dilbert::setBacklight(uint16_t)</a></code> where the parameter is a value between 0 and 1023 or <code><a class="el" href="classDilbert.html#a7622ce0cc0f19801767ee0a6b6ae17cf" title="Sets the backlight intensity. ">Dilbert::setBacklightOn(bool)</a></code> where the parameter is a boolean denoting either full brightness or off.</p>
<p>When handling buttons events from Universal Inputs the IDs are enumerated as:</p>
<ul>
<li><code><a class="el" href="classDilbert.html#a587663aa80b9a8df533d72774c909d61" title="Up buppion GPIO (on MCP23017) ">Dilbert::BUTTON_UP</a></code></li>
<li><code><a class="el" href="classDilbert.html#a257e8bd391e19434a5cbc1af17c9f863" title="Down button GPIO (on MCP23017) ">Dilbert::BUTTON_DOWN</a></code></li>
<li><code><a class="el" href="classDilbert.html#ae9100660f3b6f8b66fba92cce852351d" title="Left button GPIO (on MCP23017) ">Dilbert::BUTTON_LEFT</a></code></li>
<li><code><a class="el" href="classDilbert.html#a9eb6adbdab98cb8c9c0d60ec0833ab69" title="Right button GPIO (on MCP23017) ">Dilbert::BUTTON_RIGHT</a></code></li>
<li><code><a class="el" href="classDilbert.html#a205f6cdd1fb04659b2ec6c4c3367df01" title="A button GPIO (on MCP23017) ">Dilbert::BUTTON_A</a></code></li>
<li><code><a class="el" href="classDilbert.html#a7f2447c9c06f0de6be694d1642836e8b" title="B button GPIO (on MCP23017) ">Dilbert::BUTTON_B</a></code></li>
</ul>
<p>The values of the IDs correspond to the IO on the MCP23017 the button is connected to.</p>
<p>If using the spare IO pins of the MCP23017 be sure not to change the global interrupt configuration or the individual pin configurations of any pin connected to a button.</p>
<h2>Flashing</h2>
<ul>
<li>Clone this repository</li>
<li>Run <code>./init_submodules.sh</code> (this downloads git submodules containing libraries)</li>
<li>Install <a href="http://platformio.org">PlatfromIO</a></li>
<li>Connect the badge via an FTDI adapter</li>
<li>Hold the <em>SWD</em> switch and press the <em>RESET</em> switch, keeping <em>SWD</em> pressed while the ESP8266 resets (the LED on the ESP12 should blink once)</li>
<li><code>cd firmware</code></li>
<li><code>pio run -t upload</code></li>
<li>???</li>
<li>Profit</li>
</ul>
<h2>SD card slot</h2>
<p>There is an SD card slot, it shares the SPI bus with the display.</p>
<p>It's chip select pin is connected to the RXd pin of the ESP8266 UART.</p>
<p>I have not tested it but it should probably work OK with the <a href="https://github.com/greiman/SdFat">SdFat</a> library. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Aug 14 2016 16:44:20 for Dilbert by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
